<!doctype html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Ovo&family=Qwitcher+Grypen&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="shortcut icon" href="../anexos/icons/logoTit.png">
    <link rel="stylesheet" href="../estilo.css">
    <title>UB Social</title>
</head>
<body>
<div class="container-fluid">


    <div class="row">
        <div class="col-sm-12" id="menu">
            <nav class="navbar fixed-top navbar-expand-lg navbar-light bg-light shadow">
                <div class="container-fluid">
                    <a id="serifada" class="navbar-brand" href="../index.html"><img src="../anexos/icons/logo.png" id="logo"> UB Social</a>
                    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button>
                    <div class="collapse navbar-collapse" id="navbarNav">
                        <ul class="navbar-nav">
                            <li class="nav-item"><a class="nav-link" href="../index.html">Home</a></li>
                            <li class="nav-item"><a class="nav-link" href="../contato.html">Contato</a></li>
                            <li class="nav-item"><a class="nav-link" href="../livros.html">Livros</a></li>
                        </ul>
                    </div>
                </div>
            </nav>
        </div>
    </div>

    <div class="row">
        <div class="col-sm-12" id="titulo1">
            <h1 id="serifada">Docker</h1>
            <h6><strong>Gerenciando Containers</strong></h6>
            <a href="../index.html" class="btn btn-link" id="btnLink">Voltar</a>
        </div>

        <div class="col-sm-12">
            <p id="textoPost">Docker é software Container Engine. Há orquestradores de Container, de arquitetura distribuída, como o <i>Kubernetes</i>. Containers são pequenos pacotes de software, isolados, leves e fáceis de movimentar, diferenciando-se de VM. São baseados em <b>Imagens</b> que possuem camadas, que podem ser compartilhadas. Descartam pré configuração de ambiente físico. Além disso, ocasionam deploy mais ágil, facilitam escalabilidade, previnem erros e causam economia, sendo ideais para cloud e microservices. Os <b>namespaces</b> (Isolam os containers), <b>cgroups</b> (Limitam acesso a recursos de hardware da máquina host) e <b>union mounting</b> (Criar camadas no sistema de arquivos, que podem ser compartilhadas nos demais containers, reduzindo uso de recursos). O repositório oficial do Docker é o <b>Docker Hub</b>, composto de inúmeras imagens. Pode-se treinar Docker online através do Play With Docker, login com Docker Hub. O Docker fica salvo no diretório <i>/etc/</i>. A rede do Docker fica do 172.17.0.2 até 172.17.0.254 (172.17.0.1 é o host docker).</p>
            <ul>
                <li>Docker Hub: <a id="btnLink" href="https://hub.docker.com" target="_blank">Acesse</a></li>
                <li>Play With Docker: <a id="btnLink" href="https://labs.play-with-docker.com" target="_blank">Acesse</a></li>
            </ul>
            <br>
            <img src="../anexos/docker/exemplo.PNG" width="70%" height="auto">
        </div>
    </div>

    <div class="row">
        <div class="col-sm-12">
            <br><h4>Imagem</h4>
            <p id="textoPost">Planta de containers e dados relacionados (configurações, libraries, variáveis, outros arquivos...). Possui conceitos de camadas, onde, por exemplo, imagem Php é baseada em imagem Apache, que é baseada em imagem Debian. O passo a passo de criação de uma imagem é um arquivo chamado <b>Dockerfile</b>. <i>Entrypoint</i> são scripts que o container executa prévio à sua instalação, como receber variáveis de ambiente, geralmente pré solicitadas na construção de containers.</p>
        </div>

        <div class="row">
            <div class="col-sm-12">
                <br><h4>Instalação</h4>
                <a class="btn btn-link" id="btnLink" href="https://docs.docker.com/engine/install" target="_blank">Guia Site Oficial</a>
                <ol>
                    <li><b>Instalar Curl:</b> <i>sudo apt install curl</i></li>
                    <li><b>Instalar Docker/Curl:</b> <i>curl -fsSL https://get.docker.com | sh</i></li>
                    <li><b>Conferir instalação:</b> <i>docker -v</i></li>
                    <li><b>Caso Docker não estiver iniciado, inicie-o1:</b> <i>/etc/init.d/docker start</i></li>
                    <li><b>Caso Docker não estiver iniciado, inicie-o2:</b> <i>service docker start (Ou systemctl start docker)</i></li>
                </ol>
            </div>
        </div>

        <div class="row">
            <div class="col-sm-12">
                <br><h4>Dockerfile</h4>
                Arquivo texto de nome <i>Dockerfile</i>, com configurações da Imagem, para sua construção. Tais comandos precisam ser inseridos dentro do mesmo. Facilmente compartilhado e pode ser registrado no Docker Hub. Registry é um repositório de imagens (Ex: Portus (SUSE), Harbor, Nexus, Docker Hub (Público)). Para subir imagens (Push), é necessário login no docker hub, com comando <i>docker login</i>.
<small><pre><code>
<b>MODELO:</b>
FROM nomeImagens:versaoImagens
ENV variaveisAmbiente=valor
EXPOSE portasUtilizadas (Somente documentação, precisa ser informada na execução do container)
RUN comandos (executa comandos durante a criação da imagem)
COPY diretorioOrigem diretorioDestino (copiar código do diretório do dockerfile para diretório destino do container)
WORKDIR diretorioPadrao (Diretório padrão ao entrar no container, onde todos os comandos serão originados, como Bash)
CMD comandos (comando padrão ao executar imagem)

<b>EXEMPLO:</b>
FROM alpine
ENV DB_HOST=172.17.0.4
EXPOSE 5000
RUN apk add py3-pip
COPY * /opt/app
RUN pip3 install -r /opt/app/arquivoRequirements.txt
WORKDIR /opt/app
CMD flask run --host 0.0.0.0
</code></pre></small>
            </div>
        </div>

        <div class="row">
            <div class="col-sm-12">
                <br><h4>Comandos Docker</h4>
                Executar comandos no diretório raíz do projeto.
<small><pre><code>
<b>Criar Container:</b> docker run -d --name nomeContainer nomeImagem (Também acessa e baixa, se não há na máquina)
    <b>Ex:</b> docker run -d --rm --name meuUbuntu ubuntu
<b>Criar e entrar no container:</b> docker run -ti nomeImagem (Ctrl+p+q sai do shell sem matar container)

<b>Ver Containers em execução:</b> docker ps (-a no final mostra todos containers)
<b>Ver informações do container:</b> docker inspect idContainer (Inserir para filtro: '| grep termoPesquisa')

<b>Criar container em background, com tty e interativo:</b> docker run -dti nomeImagem
<b>Voltar para o container:</b> docker attach idContainer
<b>Criar container com variáveis de ambiente:</b> docker run -d --name banco -e MYSQL_PASSWORD=abc -e MYSQL_USER=fulano mariadb

<b>Executar comandos em Container em execução:</b> docker exec -i nomeContainer comando (bash ao invés de comando, incluindo -t, para entrar no container)
    <b>Ex:</b> docker exec -ti banco bash

<b>Sair do Container:</b> exit
<b>Iniciar container:</b> docker start idContainer (stop para)
<b>Pausar container:</b> docker pause idContainer (unpause retoma)

<b>Ver status do container:</b> docker stats idContainer
<b>Ver processos do container:</b> docker top idContainer
<b>Ver logs do container:</b> docker logs idContainer

<b>Excluir container (Parado):</b> docker rm idContainer (Incluir -f para em execução, excluir manterá imagens)
<b>Excluir todos containers:</b> docker rm -f $(docker ps -qa) (-q é quit, mostra somente id's dos containers)

<b>Construir Imagem:</b> docker build -t nomeImagem -f caminho/nomeDockerFile .
    <b>Ex:</b> docker build -t mysql-image -f api/db/Dockerfile .
<b>Ver imagens:</b> docker image ls
<b>Somente baixar imagem:</b> docker pull nomeImagem (push sobe imagem)
Exemplo nome de imagem: <i>docker.io/library/debian:buster-slim</i> (Ou usuario/nomeImagem:versaoImagem, versão padrão é latest)

<b>Criar apelido para imagem:</b> docker image tag nomeAtual novoAlternativo
<b>Excluir imagem:</b> docker image rm nomeImagem (-f para imagens com containers existentes)
<b>Construir imagem, a partir do dockerfile:</b> docker build -t nomeImagem:opcionalInfo diretorioDockerfile

<u>PARÂMETROS</u>:
idContainer pode também ser substituido pelo nome
<b>-f</b>: especifica dockerfile
<b>-d</b>: Executar Container em background
<b>--rm</b>: Sobrescreve Container com novo, caso já exista antigo similar
<b>-t</b>: tag
<b>-i</b>: Execução de comando em modo interativo, como um shell
<b>-ti</b>: TTY, utilizar emulador de Terminal
<b>-v</b>: Volume
<b>Ponto no final:</b> Especifica diretório atual
<b>$(pwd)</b>: Especifica caminho do diretório atual
<b>-p</b>: Especifica porta no Container estará exposta para porta do host (pHostDocker:pContainer)

<u><b>Resumo:</b></u>
<i>docker run -d --name banco -e MYSQL_USER=fulano -v dados:/var/lib/mysql -p 3306:3306 mariadb</i>
</code></pre></small>
            </div>
        </div>

        <div class="row">
            <div class="col-sm-12">
                <br><h4>Volume</h4>
                <p id="textoPost">Local onde ficam os dados do container, que podem ser transferidos, além do ciclo de vida do container (Ex: Dados de BD, códigos e arquivos, etc) e compartilhados com demais containers (Ao adicionar container, muda-se a porta do host docker. Cada container funciona em uma porta). Pode ser diretório local ou externo.</p>
<small><pre><code>
<b>Criar container com volume:</b> docker run -dtiv caminho/absolutoArqExterno:caminho/internoContainer -p portaHostDocker:portaContainer nomeImagem
    <b>Ex (Container Apache):</b> docker run -dv /root/destino/:/usr/local/apache2/htdocs/ -p 80:80 httpd
<b>Container com volume padrão (/var/lib/docker/):</b> docker run -d --name banco -e MYSQL_USER=fulano -v nomeVolume:/var/lib/mysql mariadb
<b>Ver volumes:</b> docker volume ls

<u><b>Exemplos:</b></u>
<b>Criar Container:</b> docker run -dv caminho1/pastaComp1:caminho2/pastaComp2 --name nomeContainer nomeImagem
<b>Ex1 (Compartilhar, na pasta do projeto, a pasta com MySQL):</b>
    -&gt; docker run -dv $(pwd)/pastaProjeto:/var/lib/mysql --name banco mysql-image
    -&gt; docker exec -i banco mysql -uroot -nomeDB &lt; pastaProjeto/script.sql
<b>Ex2 (Com porta de roteamento fora do Container, no host docker):</b>
    -&gt; docker run -dv $(pwd)/pastaProjeto:/var/lib/mysql -p 9001:9001 --name banco mysql-image
    -&gt; Conferir: No browser, acessar url 'localhost:9001/arquivo'
<b>Ex3 (Com link de apelido, pode-se trocar o ip do Container por seu apelido, para acesso):</b>
    -&gt; docker run -dv $(pwd)/pastaProjeto:/var/lib/mysql -p 9001:9001 --link apelidoContainer --name banco mysql-image
</code></pre></small>
            </div>
        </div>

        <div class="row">
            <div class="col-sm-12">
                <br><h4>Exemplo prático</h4>
                <p id="textoPost">Ambiente para Windows 10, com MySQL, Nodejs e Php. E usuários com MacOS e Linux.</p>
                <ol>
                    <li>Pasta raíz do projeto, crie pasta 'website', contendo arquivo 'index.php', com código '&lt;?php echo 'ola' ?&gt;'</li>
                    <li>Criar estrutura:
                        <ol>
                            <li><b>Criar Dockerfile (Conteúdo interno):</b>
                                <ol>
                                    <li>Importar imagem Php 7.2: <i>FROM php:7.2-apache</i></li>
                                    <li>Informar pasta de execução do Php: <i>WORKDIR /var/www/html</i></li>
                                </ol>
                            </li>
                            <li><b>Construir imagem:</b> <i>docker build -t php-image -f website/Dockerfile .</i></li>
                            <li><b>Executar container com imagem:</b> <i>docker run -dv $(pwd)/website:/var/www/html -p 8888:80 --link phpContainer --rm --name php-container php-image</i></li>
                        </ol>
                    </li>
                </ol>
            </div>
        </div>

        <div class="row">
            <div class="col-sm-12">
                <br><h4>Limitar recursos de hardware</h4>
                <p id="textoPost">O uso de CPU será proporcional à quantidade de containers presentes, com relação ao percentual da soma de CPU entre os mesmos. Ex: 3 containers, abc com 1024 (50%), def com 512 (25%) e ghi com 512 (50%). Cada unitário desses valores será 1 cpu-shares. Ex: container abc possui 1024 cpu-shares.</p>
<small><pre><code>
<b>Alterar limite de memória do container (parado):</b> docker run -ti -m 512m --name nomeContainer debian (512 MegaBytes)
<b>Alterar limite de memória do container (execução):</b> docker update -m 256m idContainer
<b>Alterar limite de CPU do container (parado):</b> docker run -ti --cpu-shares 1024 --name nomeContainer debian
<b>Alterar limite de CPU do container (execução):</b> docker update --cpu-shares 512 idContainer
</code></pre></small>
            </div>
        </div>

        <div class="row">
            <div class="col-sm-12">
                <br><h4>Docker Compose</h4>
                <p id="textoPost">Arquivo do tipo <i>yml</i> chamado '<i>docker-compose.yml</i>', contendo composto (infraestrutura IAC) de configurações para automatização docker e comunicação entre containers (via nome estabelecido) e volumes, podendo haver versionamento e, com isso, melhor organização.</p>
                
                <p><b>Utilização:</b></p>
                <p>Caso com 3 container: MySQL, Node e Php.<br>Cada service (container) possui nome à escolha do usuário (<i>db</i>, <i>api</i> e <i>web</i> neste caso). No 1º caso (<i>db</i> e <i>web</i>), simplesmente passa-se imagem e variáveis de ambiente diretamente, deixando assim de utilizar tal arquivo Dockerfile. O restart reinicia o container caso o mesmo caia. No caso do <i>build</i>, se o Dockerfile tiver nome diferente, precisa-se adicionar a pasta na propriedade <i>context</i> e, abaixo, adicionar propriedade <i>dockerfile</i> com nome do arquivo Dockerfile. Conteúdo do <i>docker-compose.yml</i> abaixo.</p>
<small><pre><code>
<b>version:</b> "3.7" (Especificar versão do Docker Compose utilizado)
<b>services:</b> (Especificar containers)
    <b>db:</b>
        <b>image:</b> mysql
        <b>container_name:</b> mysql-container
        <b>command:</b> (Para comandos shell)
        <b>environment:</b>
            MYSQL_ROOT_PASSWORD=<i>senhaBD</i>
        <b>volumes:</b>
            - ./pastaProjeto:/var/lib/mysql
        <b>restart:</b> always
    <b>api:</b>
        <b>build:</b> "./pastaComDockerfile"
        <b>container_name:</b> node-container
        <b>restart:</b> always
        <b>volumes:</b>
            - ./pastaProjeto:/home/node/app
        <b>ports:</b> "9001:9001" (PortaHost:PortaContainer)
        <b>depends_on:</b>
            - db (Pois o link do Container <i>api</i> depende do Container <i>db</i>)
    <b>web:</b>
        <b>image:</b> "php:7.2-apache"
        <b>container_name:</b> php-container
        <b>restart:</b> always
        <b>volumes:</b>
            - ./website:/var/www/html
        <b>ports:</b>
            - "8888:80"
        <b>depends_on:</b>
            - db
            - api (No caso, o <i>db</i> não precisa ser informado acima, porque o <i>api</i> já o possui como dependência)
        <b>cache:</b> (Para dados relacionados à redes)
        <b>labels:</b> (Para labels personalizadas)
        <b>#</b>blablabla (Comentário)
<b>volumes:</b>
    <b>nomeVolume:</b> {}

<u><b>COMANDOS DOCKER-COMPOSE:</b></u>
<b>Executar containers do docker-compose:</b> docker-compose up (-d executa em background)
<b>Listar container via docker-compose:</b> docker-compose ps
<b>Listar logs de container no docker-compose:</b> docker-compose logs -f nomeContainer
<b>Parar docker-compose:</b> docker-compose stop (Ou down, para parar e remover container e componentes)
<b>Entrar em container via docker-compose:</b> docker-compose exec nomeContainer bash
(Pode-se, dentro, citar outros containers pelos nomes personalizados)
</code></pre></small>
            </div>
        </div>
    </div>

<!--Rodapé-->
<div class="row">
    <div class="col-sm-12 text-center" id="rodape">
        <p id="serifada">Elaborado por Mateus Schwede<br><small class="text-muted">ubsocial.github.io</small></p>
    </div>
</div>

</div>
</body>
</html>