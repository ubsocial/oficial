<!doctype html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Ovo&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/js/bootstrap.bundle.min.js" integrity="sha384-ygbV9kiqUc6oa4msXn9868pTtWMgiQaeYH7/t7LECLbyPA2x65Kgf80OJFdroafW" crossorigin="anonymous"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="shortcut icon" href="../anexos/icons/logoTit.png">
    <link rel="stylesheet" href="../estilo.css">
    <title>UB Social</title>
</head>
<body>
<div class="container-fluid">


    <div class="row">
        <div class="col-sm-12" id="menu">
            <nav class="navbar fixed-top navbar-expand-lg navbar-light bg-light shadow">
                <div class="container-fluid">
                    <a id="serifada" class="navbar-brand" href="../index.html"><img src="../anexos/icons/logo.png" id="logo"> UB Social</a>
                    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button>
                    <div class="collapse navbar-collapse" id="navbarNav">
                        <ul class="navbar-nav">
                            <li class="nav-item"><a class="nav-link" href="../index.html">Home</a></li>
                            <li class="nav-item"><a class="nav-link" href="../contato.html">Contato</a></li>
                            <li class="nav-item"><a class="nav-link" href="../livros.html">Livros</a></li>
                        </ul>
                    </div>
                </div>
            </nav>
        </div>
    </div>

    <div class="row">
        <div class="col-sm-12" id="titulo1">
            <h1 id="serifada">Docker</h1>
            <h6><strong>Gerenciando Containers</strong></h6>
        </div>

        <div class="col-sm-12">
            <p id="textoPost">Docker é software Container Engine. Há orquestradores de Container, de arquitetura distribuída, como o <i>Kubernetes</i>. Containers são pequenos pacotes de software, isolados, leves e fáceis de movimentar, diferenciando-se de VM. São baseados em <b>Imagens</b> que possuem camadas, que podem ser compartilhadas. Descartam pré configuração de ambiente físico. Além disso, ocasionam deploy mais ágil, facilitam escalabilidade, previnem erros e causam economia, sendo ideais para cloud e microservices. Os <b>namespaces</b> (Isolam os containers), <b>cgroups</b> (Limitam acesso a recursos de hardware da máquina host) e <b>union mounting</b> (Criar camadas no sistema de arquivos, que podem ser compartilhadas nos demais containers, reduzindo uso de recursos). O repositório oficial do Docker é o <b>Docker Hub</b>, composto de inúmeras imagens. Pode-se treinar Docker online através do Play With Docker, login com Docker Hub.</p>
            <ul>
                <li>Docker Hub: <a id="btnLink" href="https://hub.docker.com" target="_blank">Acesse</a></li>
                <li>Play With Docker: <a id="btnLink" href="https://labs.play-with-docker.com" target="_blank">Acesse</a></li>
            </ul>
            <br>
            <img src="../anexos/resumo14/exemplo.PNG" width="70%" height="auto">
        </div>
    </div>

    <div class="row">
        <div class="col-sm-12">
            <br><h4>Imagem</h4>
            <p id="textoPost">Dentro da Imagem está a aplicação, libraries e outros arquivos. Ao ser movida, tudo será movido junto. São somente leitura. Através delas, criam-se containers. Com o conceito de camadas, imagens podem ser baseadas em outras, pré-existentes (Ex: Imagem Php é baseada em imagem Apache, que é baseada na Debian). Funciona de forma isolada, funcionando simultaneamente em vários containers. Arquivos de imagens são denominados <i>Dockerfile</i>.</p>
        </div>

        <div class="row">
            <div class="col-sm-12">
                <br><h4>Instalação</h4>
                <a class="btn btn-link" id="btnLink" href="https://docs.docker.com/engine/install" target="_blank">Guia Site Oficial</a>
                <ol>
                    <li><b>Instalar Curl:</b> <i>sudo apt install curl</i></li>
                    <li><b>Instalar Docker/Curl:</b> <i>curl -fsSL https://get.docker.com | sh</i></li>
                    <li><b>Conferir instalação:</b> <i>docker -v</i></li>
                    <li><b>Caso Docker não estiver iniciado, inicie-o1:</b> <i>/etc/init.d/docker start</i></li>
                    <li><b>Caso Docker não estiver iniciado, inicie-o2:</b> <i>service docker start (Ou systemctl start docker)</i></li>
                </ol>
            </div>
        </div>

        <div class="row">
            <div class="col-sm-12">
                <br><h4>Dockerfile</h4>
                Arquivo texto de nome <i>Dockerfile</i>, com configurações do Container. Tais comandos precisam ser inseridos dentro do mesmo.
<small><pre><code>
<b>1. Inserir Imagem externa:</b> FROM nomeImagem (Ou FROM nomeImagem:versaoImagem)
     <u>Ex Importar imagem MySQL</u>: FROM mysql
     <u>Ex Importar imagem Php 7.2</u>: FROM php:7.2-apache
<b>2. Inserir variáveis na imagem:</b> ENV nomeVariavel valorVariavel
     <u>Ex</u>: ENV MYSQL_ROOT_PASSWORD senhaDB
<b>3. Informar diretório de trabalho do Container:</b> WORKDIR caminho/pastaProjeto
<b>4. Informar comandos Cmd:</b> CMD comandoCmd (O comando será executado no WorkDir)
</code></pre></small>
            </div>
        </div>

        <div class="row">
            <div class="col-sm-12">
                <br><h4>Comandos Docker</h4>
                Executar comandos no diretório raíz do projeto.
<small><pre><code>
<b>Construir Imagem:</b> docker build -t nomeImagem -f caminho/nomeDockerFile .
    <b>Exemplo:</b> docker build -t mysql-image -f api/db/Dockerfile .
<b>Ver Imagens disponíveis para uso:</b> docker image ls
<b>Criar/Acessar/Baixar(Pull) Container:</b> docker run -d --rm --name nomeContainer nomeImagem
    <b>Exemplo:</b> docker run -d -rm -name mysql-container mysql-image
<b>Ver Containers em execução:</b> docker ps
<b>Ver todos Containers do host docker:</b> docker ps -a
<b>Ver todas informações do container:</b> docker inspect idContainer (Ou, no diretório do Container: docker inspect)
<b>Voltar para o container:</b> docker attach idContainer (Ou nome do Container)
<b>Executar comandos em Container em execução:</b> docker exec -i nomeContainer comando
    <b>Exemplo (Executar comando MySQL de arquivo script.sql):</b> docker exec -i mysql-container mysql -uroot -nomeDB &lt; caminho/script.sql
    <b>Ver se BD foi criado:</b> docker exec -it mysql-container /bin/bash
    <b>Dentro do Container, no Bash, consultar DB:</b>
        -&gt; mysql -uroot -nomeDB
        -&gt; show databases;
        -&gt; use nomeDB;
        -&gt; select * from nomeTable;
        -&gt; exit;
<b>Sair do Container:</b> exit
<b>Iniciar container:</b> docker start idContainer
<b>Parar Container:</b> docker stop nomeContainer
<b>Pausar container:</b> docker pause idContainer
<b>Retomar container:</b> docker unpause idContainer
<b>Ver status do container:</b> docker stats idContainer
<b>Ver processos do container:</b> docker top idContainer
<b>Ver logs do container:</b> docker logs idContainer
<b>Excluir container(Parado):</b> docker rm idContainer
<b>Excluir container em execução:</b> docker rm -f idContainer (Excluir o container manterá suas imagens)

<u>LEGENDA:</u>
<b>-t</b> = tag
<b>-f</b> = especifica dockerfile
<b>Ponto no final:</b> O contexto para gerar a Imagem parte da pasta atual na execução do comando
<b>-d</b> = Executar Container em background
<b>-rm</b> = Sobrescreve Container com novo, caso já exista antigo similar
<b>-i</b> = Execução de comando em modo interativo, como um shell
<b>-i</b>t = TTY, utilizar emulador de Terminal
<b>-v</b> = Volume
<b>$(pwd)</b> = Especifica caminho do diretório atual
<b>-p</b> = Especifica porta no Container estará exposta para porta do host (pHostDocker:pContainer)
</code></pre></small>
            </div>
        </div>

        <div class="row">
            <div class="col-sm-12">
                <br><h4>Volume</h4>
                <p id="textoPost">Possibilita compartilhamento de conteúdo/diretórios do host docker com o Container. Tudo feito em um, será refletido/alterado no outro. Quando o Container é parado/removido, todo o conteúdo realizado nele é perdido: Para evitar isso, utiliza-se Volume. Nele, cada diretório é separado por '<b>:</b>' . O Docker usa, por padrão, Containers em uma mesma rede. Porém, pode-se criar diferentes redes no Docker.</p>
<small><pre><code>
<b>Criar/Acessar Container com Volume:</b> docker run -d -v caminho1/pastaComp1:caminho2/pastaComp2 --rm --name nomeContainer nomeImagem
    <b>Exemplo(Compartilhar, na pasta do projeto, a pasta com MySQL):</b>
        -&gt; docker run -d -v $(pwd)/pastaProjeto:/var/lib/mysql --rm --name mysql-container mysql-image
        -&gt; docker exec -i mysql-container mysql -uroot -nomeDB &lt; pastaProjeto/script.sql
    <b>Exemplo2 (Com porta de roteamento fora do Container, no host docker):</b>
        -&gt; docker run -d -v $(pwd)/pastaProjeto:/var/lib/mysql -p 9001:9001 --rm --name mysql-container mysql-image
        -&gt; Conferir: No browser, acessar url 'localhost:9001/arquivo'
    <b>Exemplo3 (Com link de apelido, pode-se trocar o ip do Container por seu apelido, para acesso):</b>
        -&gt; docker run -d -v $(pwd)/pastaProjeto:/var/lib/mysql -p 9001:9001 --link apelidoContainer --rm --name mysql-container mysql-image
</code></pre></small>
            </div>
        </div>

        <div class="row">
            <div class="col-sm-12">
                <br><h4>Exemplo prático</h4>
                <p id="textoPost">Ambiente para Windows 10, com MySQL, Nodejs e Php. E usuários com MacOS e Linux.</p>
                <ol>
                    <li>Na pasta raíz de seu projeto, crie pasta 'website', contendo arquivo 'index.php', com código '&lt;?php echo 'ola' ?&gt;'</li>
                    <li>Criar Container:
                        <ol>
                            <li><b>Criar Dockerfile (Conteúdo interno):</b>
                                <ol>
                                    <li>Importar imagem Php, versão 7.2: <i>FROM php:7.2-apache</i></li>
                                    <li>Informar pasta de execução do Php: <i>WORKDIR /var/www/html</i></li>
                                </ol>
                            </li>
                            <li><b>Construir imagem:</b> <i>docker build -t php-image -f website/Dockerfile .</i></li>
                            <li><b>Executar Container com imagem:</b> <i>docker run -d -v $(pwd)/website:/var/www/html -p 8888:80 --link phpContainer --rm --name php-container php-image</i></li>
                        </ol>
                    </li>
                </ol>
            </div>
        </div>

        <div class="row">
            <div class="col-sm-12">
                <br><h4>Limitar recursos de hardware</h4>
                <p id="textoPost">O uso de CPU será proporcional à quantidade de containers presentes, com relação ao percentual da soma de CPU entre os mesmos. Ex: 3 containers, abc com 1024(50%), def com 512(25%) e ghi com 512(50%). Cada unitário desses valores será 1 cpu-shares. Ex: container abc possui 1024 cpu-shares.</p>
<small><pre><code>
<b>Ver todas informações do container:</b> docker inspect idContainer (Ou nomeContainer)
<b>Alterar limite de memória do container(parado):</b> docker run -ti -m 512m --name nomeContainer debian (512 MegaBytes)
<b>Alterar limite de memória do container(execução):</b> docker update -m 256m idContainer
<b>Alterar limite de CPU do container(parado):</b> docker run -ti --cpu-shares 1024 --name nomeContainer debian
<b>Alterar limite de CPU do container(execução):</b> docker update --cpu-shares 512 idContainer
</code></pre></small>
            </div>
        </div>

        <div class="row">
            <div class="col-sm-12">
                <br><h4>Docker Compose</h4>
                <p id="textoPost">Em grandes projetos, torna-se muito difícil gerenciar Containers e comandos dos mesmos. Para facilitar isso, usa-se Docker Compose, onde tem-se todos os comandos para a execução de um projeto macro, com vários Containers, Imagens e Volumes, em um arquivo único denominado <i>docker-compose.yml</i>.</p>
                <p><b>Passo a passo tradicional:</b></p>
                <ol>
                    <li>Construir Imagens, com <i>docker build</i></li>
                    <li>Executar Containers, com <i>docker run</i></li>
                </ol>

                <br>
                <p><b>Utilização:</b></p>
                <p>Caso com 3 Containers: MySQL, Node e Php.<br>Cada service possui nome à escolha do usuário (<i>db</i>, <i>api</i> e <i>web</i> foram da escolha do usuário, conforme seu projeto). No 1º caso (<i>db</i> e <i>web</i>), simplesmente passa-se a imagem e variáveis de ambiente diretamente, deixando assim de utilizar tal arquivo Dockerfile. O restart reinicia o container caso o mesmo caia. No caso do <i>build</i>, se o Dockerfile tiver nome diferente, precisa-se adicionar a pasta na propriedade <i>context</i> e, abaixo, adicionar propriedade <i>dockerfile</i> com nome do arquivo Dockerfile. Conteúdo do 'docker-compose.yml' abaixo.</p>
<small><pre><code>
<b>version:</b> "3.7" (Especificar versão do Docker Compose utilizado)
<b>services:</b> (Especificar containers)
    <b>db:</b>
        <b>image:</b> mysql
        <b>container_name:</b> mysql-container
        <b>command:</b> comandoContainerMysqlParaCompatibilidade (Informar 'command' só se necessário)
        <b>environment:</b>
            MYSQL_ROOT_PASSWORD: <i>senhaBD</i>
        <b>volumes:</b>
            - ./pastaProjeto:/var/lib/mysql
        <b>restart:</b> always
    <b>api:</b>
        <b>build:</b> "./pastaComDockerfile"
        <b>container_name:</b> node-container
        <b>restart:</b> always
        <b>volumes:</b>
            - ./pastaProjeto:/home/node/app
        <b>ports:</b> "9001:9001" (PortaHost:PortaContainer)
        <b>depends_on:</b>
            - db (Pois o link do Container <i>api</i> depende do Container <i>db</i>)
    <b>web:</b>
        <b>image:</b> "php:7.2-apache"
        <b>container_name:</b> php-container
        <b>restart:</b> always
        <b>volumes:</b>
            - ./website:/var/www/html
        <b>ports:</b>
            - "8888:80"
        <b>depends_on:</b>
            - db
            - api (No caso, o <i>db</i> não precisa ser informado acima, porque o <i>api</i> já o possui como dependência)
</code></pre></small>
                <p>Após criado o arquivo docker-compose.yml, executar comando de execução do projeto: <i>docker compose up -d</i>
                <br>Parar todo o projeto: <i>docker compose stop</i></p>
            </div>
        </div>


</div>
</body>
</html>