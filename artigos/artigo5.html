<!doctype html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Ovo&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/js/bootstrap.bundle.min.js" integrity="sha384-ygbV9kiqUc6oa4msXn9868pTtWMgiQaeYH7/t7LECLbyPA2x65Kgf80OJFdroafW" crossorigin="anonymous"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="shortcut icon" href="../anexos/icons/logoTit.png">
    <link rel="stylesheet" href="../estilo.css">
    <title>UB Social</title>
</head>
<body>
<div class="container-fluid">


    <div class="row">
        <div class="col-sm-12" id="menu">
            <nav class="navbar fixed-top navbar-expand-lg navbar-light bg-light shadow">
                <div class="container-fluid">
                    <a id="serifada" class="navbar-brand" href="../index.html"><img src="../anexos/icons/logo.png" id="logo"> UB Social</a>
                    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button>
                    <div class="collapse navbar-collapse" id="navbarNav">
                        <ul class="navbar-nav">
                            <li class="nav-item"><a class="nav-link" href="../index.html">Home</a></li>
                            <li class="nav-item"><a class="nav-link" href="../contato.html">Contato</a></li>
                            <li class="nav-item"><a class="nav-link" href="../livros.html">Livros</a></li>
                        </ul>
                    </div>
                </div>
            </nav>
        </div>
    </div>

    <div class="row">
        <div class="col-sm-12" id="titulo1">
            <h1 id="serifada">Auditoria de Logs</h1>
            <h6><strong>Conceitos e comandos para Linux</strong></h6>
        </div>

        <div class="col-sm-12">
            <h4>Ambiente</h4>
            <ol>
                <li>Instalar Virtualbox, com extension pack</li>
                <li>Instalar Ansible: Orquestrador de máquinas/infraestrutura, controlando-as de forma geral, via código
                    <ul>
                        <li>sudo apt update && sudo apt install software-properties-common</li>
                        <li>sudo apt install ansible</li>
                    </ul>
                </li>
                <li>Instalar Git: sudo apt install git (Configurar user e email do git)</li>
                <li>Instalar Vagrant: Automação de VMs através de arquivos de código em repositório
                    <ul>
                        <li>Baixar .deb;</li>
                        <li>No diretório das VMs, usar comando 'vagrant status' para verificar VMs para uso;</li>
                        <li>Comando 'vagrant up' iniciará todas as VMs, 'vagrant halt' desligará VMs. Arquivo 'environment.yaml' possuirá detalhes das VMs. Usuário padrão do Vagrant é 'vagrant'.</li>
                    </ul>
                </li>
            </ol>

            <br>
            <h4>Introdução ao sistema de logs</h4>
            <p id="textoPost">A utilização de logs nas rotinas profissionais é essencial para gerenciar o passo a passo do funcionamento dos sistemas. Assim como verificar problemas de forma detalhada e acessos indevidos/atividades não autorizadas. Entre os serviços de administração de logs, tem-se:</p>
            <ul>
                <li><b>syslog</b>: Mais antigo, não suporta a TCP/UDP em logs remoto, log criptografado e armazenamento de log em DB;</li>
                <li><b>syslog-ng</b>: Possui tais suportes, possuindo também versão enterprise;</li>
                <li><b>rsyslog</b>: Mais recente, possui versão enterprise e community.</li>
            </ul>
            <p><b>Elementos de configuração:</b></p>
            <ul>
                <li><b>Facility</b>: Identificação de qual serviço o log será enviado ao qual será registrado entre os demais: auth, authpriv, cron, ftp, local[0-7], lpr (Impressão), mail, news, user, kern (Kernel), syslog, daemon;</li>
                <li><b>Nível</b>: Nível de criticidade do registro do serviço ao log: Emerg, Crit, Warn, Info, Alert, Err, Notice, Debug;</li>
                <li><b>Arquivo</b>: Onde a informação será armazenada, em '/var/log/nomeServ.nivel' (Ex: /var/log/mail.err);</li>
                <li><b>Padrões</b>: Arquivos criados pelo próprio syslog automaticamente;
                    <ul>
                        <li><b>lastlog</b> (/var/log/lastlog): Logs dos últimos logins de usuários;</li>
                        <li><b>dmesg</b> (/var/log/dmesg ou comando dmesg): Logs de conexões com hardwares externos, através do reconhecimento com o kernel Linux. Informações sobre hardware;</li>
                        <li><b>messages</b>: Principais logs do sistema com relação aos serviços e afins;</li>
                        <li><b>syslog</b>: Logs de arquivos e serviços que não possuem arquivo específico para tal.</li>
                    </ul>
                </li>
            </ul>

            <br>
            <h4>Logs padrão no Linux</h4>
            <p><b>Debian</b> (/var/log/):</p>
            <ul>
                <li>alternatives.log</li>
                <li>apt</li>
                <li>auth.log</li>
                <li>btmp</li>
                <li>daemon.log</li>
                <li>debug</li>
                <li>messages (Ubuntu não possui, alternativa é o comando syslog. Também presente no Debian)</li>
            </ul>
            <p><b>CentOS</b> (/var/log/):</p>
            <ul>
                <li>anaconda</li>
                <li>audit</li>
                <li>boot.log</li>
                <li>btmp</li>
                <li>chrony</li>
                <li>cron</li>
                <li>messages (Informações sobre serviços)</li>
                <li>yum.log</li>
            </ul>
            <p>Comandos de log:</p>
            <ul>
                <li><b>dmesg</b>: Exibe arquivo /var/log/dmesg. Logs referentes à conexão de hardware externo com kernel</li>
                <li><b>last</b>: Log dos últimos logins e logouts no sistema</li>
                <li><b>lastlog</b>: Log dos últimos logins no sistema</li>
                <li><b>lastb</b>: Log das tentativas mal sucedidas de login no sistema</li>
            </ul>
            <p>Personalização de logs:</p>
            <ul>
                <li>Mostrar configuração padrão de logs: <i>cat/etc/rsyslog.conf</i></li>
                <li>Para criar configuração personalizada, deve-se ir ao diretório '/etc/rsyslog.d/'. Nele, criamos arquivo 'cron.conf'. Nesse, inserir o seguinte conteúdo:
                    <ul>
                        <li>Sintaxe: <i>facility.nivel diretorioGravacao</i></li>
                        <li>cron.* /var/log/cron.log<br>(Asterisco ativa todos os níveis para serem registrados no log)<br>(Arquivo cron.log será criado)</li>
                    </ul>
                </li>
                <li>Para confirmar o rsyslog, deve-se reiniciar o serviço: <i>sudo systemctl restart rsyslog</i></li>
                <li>Ao realizar o comando 'crontab -l' e verificar o cron.log, verá o log: <i>mês dia horário nomeMaquina serviço[processo]: (usuario) LIST (agendamentosdeusuario)</i>></li>
            </ul>

            <br>
            <h4>Rotação de logs</h4>
            <p id="textoPost">Log Rotate: Ferramenta que gerencia a organização dos logs por tamanho/tempo. Verificará o tamanho do log, dividindo-o e compactando-o. Para manter quantidade personalizada de arquivos de logs de determinado serviço, utiliza-se a rotação de logs, executado pelo crontab. Arquivos de logrotate criados automaticamente pelo sistema ficam em '/etc/logrotate.d/': Arquivos como alternatives, apt, dpkg, rsyslog, unattended-upgrades.</p>
            <p><b>Configuração padrão dos arquivos em logrotate:</b></p>
            <ul>
                <li>weekly (Agendamento de rotates - hourly, daily, weekly ou monthly)</li>
                <li>rotate 4 (Quantidade de arquivos de logs que devem ser mantidos)</li>
                <li>create (Criar arquivo de log quando o rotacionamento é feito)</li>
                <li>compress (Comprimir arquivo de log para formato gzip - .gz)</li>
                <li>missingok (Não fará roticionamento se o arquivo não existir)</li>
                <li>notifempty (Não fará roticionamento de arquivo vazio)</li>
            </ul>
            <p>Criar rotate para arquivo criado acima, cron.log, Criando, em /etc/logrotate.d/, arquivo 'cron', com o conteúdo:</p>
<small><pre><code>
/var/log/cron.log {
    daily
    rotate 4
    compress
    delaycompress (Compacta a partir do 2º logrotate)
    size 1M (Fará o roticionamento quando o arquivo atingir 1M)
    missingok
    notifempty
    create 644 root root (Criará novos arquivos / permissão / usuario / grupo)
}
</code></pre></small>
            <p id="textoPost">O arquivo <i>cron.log</i> estará no rsyslog, caso isso aconteça, comente a linha (#) de sua referência no arquivo /var/log/rsyslog (<i>#/var/log/cron.log</i>). Quando o arquivo cron.log passar do tamanho definido, pode-se fazer o logrotate dele ou aguardá-lo automaticamente, de acordo com o provisionamento definido. Para realizar o logrotate forçadamente, use o comando <i>logrotate -f /etc/logrotate.conf</i>, que irá ler as configurações definidas nos arquivos em /etc/logrotate.d/ e, se preciso, executará o logrotate. Os arquivos envolvidos em logrotate ficarão em /var/log, onde os arquivos estarão com nomeclatura <i>nomeArquivo.log.1</i> e, caso houver atributo delaycompress, na 2ª execução do logrotate aparecerá o arquivo <i>nomeArquivo.log.2.gz</i>. Respectivamente, a cada próxima execução, será criado o arquivo <i>nomeArquivo.log.3.gz</i>, onde manterá somente os últimos X arquivos, de acordo com a quantidade definida no 'rotate' do mesmo (Ex: rotate 4 manterá somente os últimos 4 arquivos). Automaticamente, o período padrão de execução do logrotate está definido em <i>/etc/crontab</i>, onde haverá os diretórios apontados em <i>/etc/cron.daily</i>, <i>/etc/cron.weekly</i>, etc, que possuirão os arquivos com incluídos. Com 'cat /etc/crontab' as 2 primeiras colunas representam, respectivamente, quais minutos, hora, dia... do período ocorrerá o logrotate.</p>
            <p><b>Resolvendo problemas através de logs:</b></p>
            <ul>
                <li><b>Cenário 1 (Erro de configuração de serviço):</b> Exemplo, um comando errado no arquivo /etc/rsyslog.conf (Após restart do serviço, verificar com 'systemctl status rsyslog', ou verificar arquivo /var/log/syslog)</li>
                <li><b>Cenário 2 (Erro de autenticação no sistema através de um usuário, de máquina à outra)</b>:
                    <ul>
                        <li>PS: <i>mail.info /var/log/infomail.log</i> enviará informações de serviços de email para o arquivo de log especificado</li>
                        <li>Usuário, via VM1, acessa VM2: <i>sshpass -p "senhaErrada" ssh -l nomeUsuario nomeVM</i></li>
                        <li>Na VM2, verificar se houve tentativas mal sucedidas de acesso: <i>sudo grep Failed /var/log/secure --color</i></li>
                    </ul>
                </li>
            </ul>

            <br>
            <h4>Auditoria de acessos ao sistema</h4>
            <p id="textoPost">Audit: Serviço que permite gerar logs de sistema através de regras. Instalar Audit: <i>sudo apt install auditd</i></p>
            <ul>
                <li>Ver status: <i>sudo auditctl -s</i></li>
                <li>Listar regras: <i>sudo auditctl -l</i></li>
                <li>Criar regra de auditoria de log em arquivo: sudo auditctl -w /diretorio/arquivo -p rwxa (-p permissões)
                    <ul>
                        <li>Ex: <i>sudo auditctl -w /etc/passwd -p rwxa</i>
                            <ol>
                                <li>Ler o arquivo /etc/passwd (<i>cat passwd</i>)</li>
                                <li>Verificar se audit pegou a leitura do arquivo: <i>sudo grep -i passwd /var/log/audit/audit.log</i></li>
                                <li>Também pode-se ler todo o arquivo de log gerado pelo audit: <i>sudo cat /var/log/audit/audit.log</i></li>
                            </ol>
                        </li>
                    </ul>
                </li>
                <li>Remover regra: <i>sudo auditctl -W /diretorio/arquivo</i>
                    <ul>
                        <li>Ex: <i>sudo auditctl -W /etc/passwd</i></li>
                    </ul>
                </li>
            </ul>

            <br>
            <h4>Regra para execução de syscalls</h4>
            <p id="textoPost">Syscalls (Chamadas de sistema) é a interface entre aplicação e kernel. Exemplo: Mudança de hora realizada pela aplicação.</p>
            <p><b>Criar regra para auditar mudança do horário do sistema:</b></p>
            <ul>
                <li>Criar regra para syscall: <i>sudo auditctl -a exit,always -F arch=b64 -S clock_settime -F key=mudarHora</i> (always marca o tempo e grava o registro. exit permite criar evento quando a syscall for encerrada. -F filtro de syscall para arquitetura. -S define o que será registrado. key define variável string)</li>
                <li>Alterar hora do sistema: <i>sudo date --set '2021/01/01 20:00"</i></li>
                <li>Procurar apontamento no audit.log: <i>sudo grep -i mudarHora /var/log/audit/audit.log</i> (Ou cta nesse arquivo)</li>
                <li>Listar registros syscall: <i>sudo ausyscall --dump (Ver nº do syscall no comando acima e procurá-lo nessa lista)</i>
                    <ul>
                        <li>Procurar diretamente: <i>sudo ausyscall --dump | grep numSyscall</i> (Ex: 227)</li>
                    </ul>
                </li>
                <li>Remover regra: <i>sudo auditctl -d exit,always -F arch=b64 -S clock_settime -F key=mudarHora</i>
                    <ul>
                        <li>Verificar se regra foi removida ou não: <i>sudo auditctl -l</i></li>
                    </ul>
                </li>
            </ul>
            <p><b>Criar regras automaticamente ao iniciar máquina:</b></p>
            <p>Para isso, define-se as regras dentro do arquivo /etc/audit/rules.d/audit.rules</p>
            <ul>
                <li>Criar regra para arquivo: <i>sudo auditctl -w /etc/passwd -p rwxa -k listaUsuarios</i></li>
                <li>Criar regra para syscall: <i>sudo auditctl -a exit,always -F arch=b64 -S clock_settime -k mudarHora</i></li>
                <li>Listar regras, para ver se foram criadas: <i>sudo auditctl -l</i></li>
                <li>Encaminhar lista para final do arquivo audit.rules: <i>auditctl &gt;&gt; /etc/audit/rules.d/audit.rules</i></li>
                <li>Para efeito, pode-se reiniciar a máquina ou seguir os comandos
                    <ul>
                        <li>Remover todas regras: <i>sudo auditctl -D</i></li>
                        <li>Listar, para comprovar remoção: <i>sudo auditctl -l</i></li>
                        <li>Reiniciar serviço auditd: <i>systemctl restart auditd</i></li>
                        <li>Listar, para comprovar regras efetivadas: <i>sudo auditctl -l</i></li>
                        <li>Lista de syscalls: <a href="https://man7.org/linux/man-pages/man2/syscalls.2.html" target="_blank">Acesse</a></li>
                    </ul>
                </li>
            </ul>

            <br>
            <h4>Analisar logs de auditoria</h4>
            <p id="textoPost">Para gerar relatórios de logs envolvendo as 2 regras acima, usaremos ausearch e aureport. Ausearch é ideal para comprimir comandos com variáveis. Ausearch é ideal para exibir, em analise de logs, quantidade de falhas na autenticação de usuários por exemplo.</p>
            <ul>
                <li>Acessar arquivo, para pegá-lo no log d arquivo: <i>cat /etc/passwd</i></li>
                <li>Mudar horário do sistema, para pegá-la no log syscall: <i>date --set "1999/04/11 9:30"</i></li>
                <li>Ver/Filtrar eventos no arquivo /etc/passwd através ausearch: <i>ausearch -k listaUsuarios</i></li>
                <li>Ver/Filtrar eventos no syscall hora através do ausearch: <i>ausearch -k mudarHora</i></li>
                <li>Ver logs específicos (Exemplo crontab) através do ausearch: <i>ausearch -x /usr/bin/crontab</i></li>
                <li>Mostrar relatório do sistema, através do aureport: <i>aureport --summary</i>
                    <ul>
                        <li>Mostrar tudo: <i>aureport -f</i></li>
                        <li>Em tempo real: <i>aureport -f | tail -f</i></li>
                    </ul>
                </li>
                <li>Mostrar relatório de usuários: <i>aureport -m</i></li>
            </ul>

            <br>
            <h4>Auditoria em tempo real</h4>
            <p id="textoPost">PAM (Pluggable Authentication Modules) são módulos que fazem gerenciamento de logs no Linux, como autenticação, trocas de sessão, digitação, etc. Ele se encontra em <i>/etc/pam.d/</i>. Nele, os arquivos 'common' servem como modelos. Arquivos como 'login' mostram configuração para regras de login. Os arquivos seguem padrão de 4 partes:<br>[Interação] [Controle] [Módulo de controle] [Parâmetros do módulo]<br>auth/session optional/sufficient/requisite/required modulo.so delay=3000000<br>Exemplos:</p>
            <ul>
                <li><i>auth requisite pam_nologin.so</i> (Se há arquivo /etc/nologin, o root não poderá logar)</li>
                <li><i>auth requisite pam_time.so</i> (Se há arquivo /etc/security/time.conf, haverá determinados horários para login)</li>
            </ul>
            <p id="textoPost">* <b>Required</b> verifica e não bloqueia na 1ª vez carregado, olhando outros módulos para então tomada de decisão. Se os demais módulos bloquearem, aí ele bloqueia também. <b>Requisite</b> bloqueia direto. <b>Sufficient</b> não impactará bloqueios caso o módulo falhe, passando para o próximo módulo.</p>
            <p>Exemplo:</p>
            <p id="textoPost"><b>pam_tty_audit</b> faz auditoria em logs de tudo o que for digitado no shell, registrando em <i>/var/log/audit/audit.log</i>. Neste caso, usará auditoria em tempo real para verificar o que o root estará digitando no shell.</p>
            <ol>
                <li>A sessão do usuário deverá ser requerida para uso do módulo: Inserir no final do arquivo /etc/pam.d/commom-password, a regra: <i>session required pam_tty_audit.so disable=* enable=root log_passwd</i></li>
                <li>Adicionar regras de auditorias em <i>/etc/audit/rules.d/audit.rules</i>, para captar todos binários envolvidos com root:
                    <ul>
                        <li><i>echo '-a always,exit -F arch=b64 -F euid=0 -s execve' &gt;&gt; /etc/audit/rules.d/audit.rules</i></li>
                        <li><i>echo '-a always,exit -F arch=b32 -F euid=0 -s execve' &gt;&gt; /etc/audit/rules.d/audit.rules</i></li>
                    </ul>
                </li>
                <li>Reiniciar audit: <i>systemctl restart auditd</i></li>
                <li>(Tudo o que o root digitar no shell será registrado no /var/log/audit/audit.log)</li>
            </ol>
            <p>Instalar plugin para evitar que o arquivo de registro desse log (<i>/var/log/audit/audit.log</i>) seja outro:</p>
            <ol>
                <li>Instalar: sudo apt install audispd-plugins (Após instalado, criará <i>/etc/audisp/plugins.d/</i>)
                    <ul>
                        <li>Os arquivos têm configurações, que podem ser ativadas (active), que permitem redirecionar resultados de logs para outros arquivos especificados.</li>
                        <li>No arquivo /etc/audisp/plugins.d/syslog.conf, ativar o arquivo com '<i>active = yes</i>'.</li>
                        <li>Editar arquivo /etc/rsyslog.d/50-default.conf, remover comentários das linhas 31, 32, 33 e 34 (<i>*.=info… até mail,news,none ~/var/log/messages</i>)
                            <ul>
                                <li>Todos logs info serão redirecionados para <i>~/var/log/messages</i></li>
                            </ul>
                        </li>
                    </ul>
                </li>
                <li>Reiniciar rsyslog e audit: <i>systemctl restart rsyslog && systemctl restart auditd</i></li>
                <li>Será criado arquivo <i>/var/log/messages</i>, onde ficarão todos logs de info, assim como os logs que registram o que o root escreve no shell (Isso, além do arquivo audit.log primeiramente criado).</li>
                <li>Para retransmitir a outra nível (local, info...):
                    <ul>
                        <li>Editar /etc/audisp/plugins.d/syslog.conf, alterar <i>ARGS</i> para '<i>LOG_LOCAL6</i>'</li>
                        <li>Editar /etc/rsyslog.d/50-default.conf, alterar, nas linhas 31, 32, 33, 34 propriedade '<i>.none</i>', que impede de gravar logs destes do no arquivo informado (~/var/log/messages). Junto, após 'news.none' informar '<i>;local6.none</i>' (No caso, desabilitar os logs de local6 para serem informados no arquivo messages)</li>
                        <li>Reiniciar rsyslog e audit: <i>systemctl restart rsyslog && systemctl restart auditd</i></li>
                        <li>Ver, em /var/log/audit/audit.log, que os logs dos comandos que o root digitou no shell foram registrados
                            <ul>
                                <li>Nada disso foi registrado em /var/log/messages</li>
                            </ul>
                        </li>
                    </ul>
                </li>
            </ol>

            <br>
            <h4>Logs remoto</h4>
            <p id="textoPost">A ideia de centralizar logs em um servidor para facilitar a análise e backups. O rsyslog, em <i>/etc/rsyslog.conf</i>, fornece disposição de logs remoto através de TCP/UDP na porta 514 ($InputTCPServerRun). Pode-se alterar tal porta, informando-a nos arquivos abaixo (Ex: Recebimentos de logs em TCP porta 514 é input(type="imtcp" port="514")).</p>
            <p><b>Máquina Servidor (Debian):</b></p>
            <p id="textoPost">Ativar recebimento de requisições de logs externos, em <i>/etc/rsyslog.conf</i>, Modules descomentar linhas 17, 18, 21 e 22 (<i>#module... e #input(type...</i>), após isso reiniciar rsyslog (<i>sudo systemctl restart rsyslog</i>). Para testar se o servidor está atendendo à essa porta, usa-se <i>ss -nlptu | grep 514</i>. Verificar ip da máquina servidor com <i>ip a</i> na parte eth1 inet.</p>
            <p id="textoPost">Configurar template para separar os logs de cada máquina: Criar diretório <i>sudo mkdir /srv/log/ && sudo chown syslog:syslog -R /srv/log</i>. Em <i>/etc/rsyslog.conf.d/</i>, criar arquivo chamado 'template.conf', inserindo o seguinte conteúdo:</p>
<small><pre><code>
template (name="LogRemoto" type="string" string="/srv/log/%HOSTNAME%/%PROGRAMNAME%.log")
*.* ?LogRemoto
</code></pre></small>
            <p id="textoPost">Após finalizado o arquivo, reiniciar rsyslogs <i>sudo systemctl restart rsyslog</i>. Conferir também se o rsyslog está operando com sucesso <i>sudo systemctl status rsyslog</i>. A 1ª linha especifica que todos os logs serão enviados para o diretório destino informado, sendo-os separados pelo nome de cada máquina e seu respectivo programa que está enviando o log. A 2ª linha epecifica os logs da própria máquina servidor, sendo respectivamente 'facility.nivel', onde os mesmos serão enviados para o local LogRemoto, definido no template.</p>
            <p><b>Máquina Cliente (CentOS):</b></p>
            <p id="textoPost">Em <i>/etc/rsyslog.conf</i>, inserir no final:</p>
<small><pre><code>
# *.* @@NomeOuIpServidor:514 (@ é UDP. @@ é TCP)
*.* @@graylog:514 (O nome do servidor é graylog)

<u>Exemplo (UDP):</u> \*.\* @172.16.0.100**
</code></pre></small>
            <p id="textoPost">Após finalizar arquivo, fazer teste de conexão <i>ping -c4 graylog</i>. Caso a máquina não reconheça o servidor, verificar arquivo '/etc/hosts'. Se os 4 pacotes foram transmitidos com sucesso, deve-se reiniciar o rsyslog <i>sudo systemctl restart rsyslog</i>. Agora, na máquina servidor aparecerão, em '/srv/log/', os logs da máquina cliente.</p>

            <br>
            <h4>Criptografia TLS</h4>
            <p id="textoPost">A criptografia em logs é essencial para a segurança dos mesmos. O Certtool é a ferramenta para gestão de certificados em chaves de criptografia.</p>
            <p><b>Máquina Servidor (Ubuntu / graylog):</b></p>
            <ul>
                <li>Instalar pacotes para permitir criptografia e gerar certificado em chaves: <i>sudo apt install rsyslog-gnutils gnutils-bin</i></li>
                <li>Criar e acessar diretório para guardar as chaves de criptografia: <i>mkdir /etc/rsyslog-keys && cd /etc/rsyslog-keys</i></li>
            </ul>
            <p><b>Máquina Cliente (CentOS / webserver):</b></p>
            <ul>
                <li>Instalar pacote para permitir criptografia: <i>sudo yum install rsyslog-gnutils</i></li>
                <li>Criar diretório para guardar chaves: <i>mkdir /etc/rsyslog-key</i></li>
            </ul>
            <p><b>Máquina Cliente (Debian / kibana):</b></p>
            <ul>
                <li>Instalar pacote para permitir criptografia: <i>sudo apt install rsyslog-gnutils</i></li>
                <li>Criar diretório para guardar chaves: <i>mkdir /etc/rsyslog-key</i></li>
            </ul>
            <p><b>Máquina Servidor (Ubuntu):</b></p>
            <ul>
                <li>Em /etc/rsyslog-keys, gerar chave para o próprio servidor: <i>certtool --generate-privkey --outfile ca-key.pem</i> (O comando criará chave privada no próprio diretório de criação)</li>
                <li>Alterar permissões da chave (Somente dono pode ler): <i>sudo chmod 400 ca-key.pem</i></li>
                <li>Gerar certificado auto assinado com a chave ca-key: <i>certtool --generate-self-signed --load-privkey ca-key.pem --outfile ca.pem</i>. Informar os seguintes campos solicitados e informados:
                    <ul>
                        <li>Common name: graylog (Mesmo nome do servidor)</li>
                        <li>The certificate will expire in (days): 3650</li>
                        <li>Does the certificate belong to an authority? (y,N): y</li>
                        <li>Enter a dnsName of the subject of the certificate: graylog (Mesmo nome do servidor)</li>
                        <li>Will the certificate be used to sign other certificates? (y,N): y</li>
                        <li>Will the certificate be used to sign CRLs? (y,N): y</li>
                        <li>Is the above information ok? y</li>
                        <li>(Com isso, será gerado nesse mesmo diretório o certificado 'ca.pem'.)</li>
                    </ul>
                </li>
            </ul>

            <h5>Criar chaves:</h5>
            <ul>
                <li>Em /etc/rsyslog, informar:
                    <ul>
                        <li>certtool --generate-privkey --outfile webserver-key.pem --bits 2048 (Webserver é o nome da máquina cliente 1)</li>
                        <li>certtool --generate-privkey --outfile kibana-key.pem --bits 2048 (Kibana é o nome da máquina cliente 2)</li>
                        <li>(Criará chave webserver-key.pem e kibana-key.pem neste diretório)</li>
                    </ul>
                </li>
            </ul>

            <h5>Criar requisições:</h5>
            <p id="textoPost">Requests são necessárias para cada máquina gerar certificados auto assinados. Os arquivos gerados de requests (*-request.pem) podem ser removidos após criação dos certificados.</p>
            <ul>
                <li>certtool --generate-request --load-privkey webserver-key.pem --outfile webserver-request.pem
                    <ul>
                        <li>Common name: webserver (Nome da máquina)</li>
                        <li>Enter a dnsName of the subject of the certificate: webserver</li>
                        <li>Will be certificate be used for signing (DHE ciphersuites)? (y,N): y</li>
                        <li>(Com isso, será gerado arquivo webserver-request.pem)</li>
                    </ul>
                </li>
                <li>certtool --generate-request --load-privkey kibana-key.pem --outfile kibana-request.pem
                    <ul>
                        <li>Common name: kibana (Nome da máquina)</li>
                        <li>Enter a dnsName of the subject of the certificate: kibana</li>
                        <li>Will be certificate be used for signing (DHE ciphersuites)? (y,N): y</li>
                        <li>(Com isso, será gerado arquivo kibana-request.pem)</li>
                    </ul>
                </li>
            </ul>

            <h5>Criar certificado auto assinado para máquinas clientes:</h5>
            <ul>
                <li>certtool --generate-certificate --load-request webserver-request.pem --outfile webserver-cert.pem --load-ca-certificate ca.pem --load-ca-privkey ca.key.pem
                    <ul>
                        <li>The certificate will expire in (days): 1000</li>
                        <li>Is this a TLS web client certificate? (y,N): y</li>
                        <li>Is this a TLS web server certificate? (y,N): y</li>
                        <li>Enter a dnsName of the subject of the certificate: webserver (Nome da máquina)</li>
                        <li>Is the above information ok? y</li>
                        <li>(Com isso, gerará arquivo webserver-cert.pem)</li>
                    </ul>
                </li>
                <li>certtool --generate-certificate --load-request kibana-request.pem --outfile kibana-cert.pem --load-ca-certificate ca.pem --load-ca-privkey ca.key.pem
                    <ul>
                        <li>The certificate will expire in (days): 1000</li>
                        <li>Is this a TLS web client certificate? (y,N): y</li>
                        <li>Is this a TLS web server certificate? (y,N): y</li>
                        <li>Enter a dnsName of the subject of the certificate: kibana (Nome da máquina)</li>
                        <li>Is the above information ok? y</li>
                        <li>(Com isso, gerará arquivo kibana-cert.pem)</li>
                    </ul>
                </li>
                <li>Copiar arquivos para máquinas webserver e kibana:
                    <ul>
                        <li>scp ca.pem webserver* nomeUsuario@webserver:/tmp (Informar yes)</li>
                        <li>scp ca.pem kibana* nomeUsuario@kibana:/tmp (Informar yes)</li>
                    </ul>
                </li>
            </ul>
            <p><b>Máquina Cliente (CentOS / webserver):</b></p>
            <ul>
                <li>mv /tmp/ca.pem /etc/rsyslog-keys/ && mv /tmp/webserver*.pem /etc/rsyslog-keys/</li>
                <li>Pode-se testar com 'ls /etc/rsyslog-keys' para verificar se os determinados arquivos encontram-se corretamente no diretório destino.</li>
            </ul>
            <p><b>Máquina Cliente (Debian / kibana):</b></p>
            <ul>
                <li>mv /tmp/ca.pem /etc/rsyslog-keys/ && mv /tmp/kibana*.pem /etc/rsyslog-keys/</li>
                <li>Pode-se testar com 'ls /etc/rsyslog-keys' para verificar se os determinados arquivos encontram-se corretamente no diretório destino.</li>
            </ul>
            <p><b>Máquina Server (Ubuntu / graylog):</b></p>
            <ul>
                <li>Copiar modelo de configuração TLS: cp /opt/syslog-tls.conf /etc/rsyslog.d/</li>
                <li>O arquivo /etc/rsyslog.d/syslog-tls.conf possui as informações de configuração e criptografia. Alterar permissão do mesmo: sudo chown syslog:syslog -R /etc/rsyslog.conf/</li>
                <li>Editar arquivo /etc/rsyslog.conf, comentar linhas que anteriormente foram descomentadas (17, 18, 21 e 22). Após salvar o arquivo, reiniciar rsyslog 'sudo systemctl restart rsyslog'.</li>
                <li>Por fim, verificar se está atendendo na porta 6514: 'ss -nlptu | grep 6514'.</li>
            </ul>
            <p><b>Máquina Cliente (CentOS / webserver):</b></p>
            <ul>
                <li>Copiar modelo de configuração TLS: cp /opt/syslog-tls.conf /etc/rsyslog.d/. Comentar, no arquivo /etc/rsyslog.conf, última linha preenchida nos passos acima.</li>
                <li>Após isso, reiniciar rsyslog 'sudo systemctl restart rsyslog'.</li>
            </ul>
            <p><b>Máquina Cliente (Debian / kibana):</b></p>
            <ul>
                <li>Copiar modelo de configuração TLS: cp /opt/syslog-tls.conf /etc/rsyslog.d/.</li>
                <li>Comentar, no arquivo /etc/rsyslog.conf, última linha preenchida nos passos acima.</li>
                <li>Após isso, reiniciar rsyslog 'sudo systemctl restart rsyslog'.</li>
            </ul>
            <p><b>Máquina Servidor (Ubuntu / graylog):</b></p>
            <ul>
                <li>Verificar se tudo funcionou e há criptografia nas auditorias: tail -f /var/log/webserver/messages. Ir na máquina cliente webserver (debian) e reiniciar rsyslog.</li>
                <li>Então, na máquina servidor (ubuntu) serão incorporadas novas mensagens de logs, sendo essas criptografadas.</li>
                <li>(O mesmo vale para a máquina cliente kibana (debian).)</li>
            </ul>

            <br>
            <h4>Armazenar logs no MySQL</h4>
            <p id="textoPost">O rsyslog trás o armazenamento dos logs padrão em arquivos, mas também conta com suporte a BDs Relacionais e NoSQL (Módulo ommysql). O ideal é possuir o BD em máquina separada da máquina servidor, mas nesse caso ocorrerá na mesma máquina. Na máquina servidor:</p>
            <ul>
                <li>Instalar plugin rsyslog: <i>sudo DEBIAN_FRONTEND=noninteractive apt install mysql-server mysql-client mysql-common rsyslog-mysql</i></li>
                <li>Conectar mysql: <i>mysql -u root -e 'CREATE DATABASE Syslog;'</i>
                    <ul>
                        <li>Conferir se o BD foi criado: <i>mysql -u root -e 'SHOW DATABASES;'</i></li>
                    </ul>
                </li>
                <li>Ver arquivo BD rsyslog: cat /usr/share/dbconfig-common/data/rsyslog-mysql/install/mysql
                    <ul>
                        <li>Popular BD com o conteúdo do arquivo: <i>mysql -u root -D Syslog &gt; /usr/share/dbconfig-common/data/rsyslog-mysql/install/mysql</i></li>
                        <li>Conferir BD Syslog: <i>mysql -u root -D Syslog -e 'SHOW TABLES;'</i></li>
                        <li>Verificar estrutura das tables: <i>mysql -u root -D Syslog -e 'DESC SystemEvents;'</i></li>
                        <li>Criar usuário para acessar BD: <i>mysql -u root -D Syslog -e "CREATE USER rsysloguser@localhost IDENTIFIED BY 'rsyslogpw';"</i></li>
                        <li>Definir acesso ao usuário: <i>mysql -u root -D Syslog -e 'GRANT ALL ON Syslog.* TO rsysloguser@localhost;'</i>
                            <ul>
                                <li>Se o acesso fosse remoto, deveria-se colocar o % após o @</li>
                            </ul>
                        </li>
                        <li>Editar arquivo /etc/rsyslog.d/mysql.conf, alterar uid="rsysloguser" e pwd="rsyslogpw"</li>
                    </ul>
                </li>
                <li>Reiniciar rsyslog: sudo systemctl restart rsyslog
                    <ul>
                        <li>Verificar se rsyslog está operando: sudo systemctl status rsyslog</li>
                    </ul>
                </li>
                <li>Listar dados das tabelas, para conferência: <i>mysql -u root -D Syslog -e 'SELECT ID, fromHost, Message FROM SystemEvents;'</i>
                    <ul>
                        <li>Testar log de digitação no shell pelo root: (Em root) systemctl restart rsyslog</li>
                        <li>Realizar novamente o select acima para verificar se o log citado foi incluído na table</li>
                    </ul>
                </li>
            </ul>

            <br>
            <h4>Backup e Restore de logs</h4>
            <p><b>Backup:</b></p>
            <ul>
                <li>Fazer dump (backup) de base de dados: <i>mysqldump Syslog &gt; backup-banco-syslog.sql</i></li>
                <li>Dump de table à parte: <i>mysqldump Syslog SystemEvents &gt; backup-tabela-system-events.sql</i></li>
            </ul>
            <p><b>Restore (Através do backup acima):</b></p>
            <ul>
                <li>Remover table SystemEvents: <i>mysql -u root -D Syslog -e 'DROP TABLE SystemEvents;'</i></li>
                <li>Realizar restore: <i>mysql -u root -D Syslog &lt; backup-tabela-system-events.sql</i></li>
            </ul>
            <p><b>Agendamento de backups:</b></p>
            <p id="textoPost">Criar, em <i>/opt/</i>, script de backup (<i>bkp-banco.sh</i>):</p>
<small><pre><code>
#!/bin/bash
mysqldump --user="rsysloguser" --password="rsyslogpw" "$@" "Syslog" &gt; "/opt/backup/syslog-$(date '+%d-%n-%Y')".sql 2&gt; /dev/null
</code></pre></small>
            <ul>
                <li>Copiar script: <i>cp /opt/bkkp-banco.sh /usr/local/bin/ && chmod u+x /usr/local/bin/bkp-banco.sh</i></li>
                <li>Criar diretório backup: <i>mkdir /opt/backup</i></li>
                <li>Executar script: <i>bash /usr/local/bin/bkp-banco.sh</i>
                    <ul>
                        <li>Verificar funcionamento: <i>ls /opt/backup</i></li>
                    </ul>
                </li>
                <li>Mover para cron daily, para executar script automaticamente diariamente: <i>cp /usr/local/bin/bkp-banco.sh etc/cron.daily/bkp-banco</i>
                    <ul>
                        <li>Verificar funcionamento: <i>rm /opt/backup/* && run-parts /etc/cron.daily && ls /opt/backup</i></li>
                    </ul>
                </li>
            </ul>
            <p id="textoPost">PS: Usuário e senha foram criados em /etc/rsyslog.d/rsyslog.conf no conteúdo acima. Arquivos no cron daily remove-se extensão.</p>

            <br>
            <h4>Centralização de logs com Graylog</h4>
            <img src="../anexos/artigo5/graylog.png" width="70%" height="auto">
            <p id="textoPost">Graylog é software de gerenciamento de logs, funcionando em conjunto com MongoDB e Elasticsearch, viabilizando criação de filtros, alertas, deashboards e aumentando a velocidade de pesquisa de mensagens. Pode ser utilizado em cluster, via master e slaves. MongoDB armazenará as configurações do Graylog e o Elasticsearch o armazenamento dos logs.</p>
            <p><b>Pré-requisitos:</b></p>
            <ul>
                <li>sudo apt update</li>
                <li>sudo apt install apt-transport-https openjdk-8-jre-headless uuid-runtime pwgen</li>
                <li>Configurar $JAVA_HOME para Elasticsearch:
                    <ul>
                        <li>sudo nano /etc/environment (Inserir no final do arquivo): JAVA_HOME="/usr/lib/jvm/java-1.8.0-openjdk-amd64/bin/"</li>
                        <li>source /etc/environment
                            <ul>
                                <li>Testar funcionamento: <i>echo $JAVA_HOME</i> (Deverá retornar diretório informado)</li>
                            </ul>
                        </li>
                    </ul>
                </li>
            </ul>
            <p><b>Instalar MongoDB 4 (Debian):</b></p>
            <ul>
                <li>Instruções conforme https://docs.mongodb.com/v4.0/tutorial/install-mongodb-on-debian</li>
                <li>wget -qO - https://www.mongodb.org/static/pgp/server-4.0.asc | sudo apt-key add -</li>
                <li>echo "deb http://repo.mongodb.org/apt/debian stretch/mongodb-org/4.0 main" | sudo tee /etc/apt/sources.list.d/mongodb-org-4.0.list
                    <ul>
                        <li>Verificar versão do Debian acima (jessie/stretch)</li>
                    </ul>
                </li>
                <li>sudo apt update && sudo apt install mongodb-org</li>
                <li>sudo systemctl enable mongod.service
                    <ul>
                        <li>sudo systemctl start mongod.service</li>
                        <li>Verificar funcionamento: sudo systemctl status mongod</li>
                    </ul>
                </li>
            </ul>
            <p><b>Instalar Elasticsearch:</b></p>
            <ul>
                <li>Instruções conforme https://www.elastic.co/guide/en/elasticsearch/reference/current/deb.html</li>
                <li>wget -qO - https://artifacts.elastic.co/GPG-KEY-elasticsearch | sudo apt-key add -</li>
                <li>echo "deb https://artifacts.elastic.co/packages/7.x/apt stable main" | sudo tee /etc/apt/sources.list.d/elastic-7.x.list</li>
                <li>sudo apt update && sudo apt install elasticsearch</li>
                <li>sudo nano /etc/elasticsearch/elasticsearch.yml
                    <ul>
                        <li>(Editar no arquivo): cluster.name: nomeMaquina (Ex: graylog)</li>
                    </ul>
                </li>
                <li>sudo nano /etc/elasticsearch/jvm.options
                    <ul>
                        <li>(Editar no arquivo, linhas 22 e 23):
                            <ul>
                                <li>-Xms512m</li>
                                <li>-Xmx512m</li>
                            </ul>
                        </li>
                    </ul>
                </li>
                <li>sudo systemctl enable elasticsearch.service
                    <ul>
                        <li>sudo systemctl start elasticsearch.service</li>
                        <li>Verificar funcionamento: sudo systemctl status elasticsearch.service</li>
                    </ul>
                </li>
            </ul>
            <p><b>Instalar Graylog:</b></p>
            <ul>
                <li>wget https://packages.graylog2.org/repo/packages/graylog-4.2-repository_latest.deb</li>
                <li>sudo dpkg -i graylog-4.2-repository_latest.deb</li>
                <li>sudo apt update && sudo apt install graylog-server</li>
                <li>sudo systemctl enable graylog.service
                    <ul>
                        <li>sudo systemctl start graylog.service</li>
                        <li>Verificar funcionamento: sudo systemctl status graylog.service (Pode ocorrer erro devido a não configuração abaixo)</li>
                    </ul>
                </li>
                <li>Gerar senha de autenticação graylog: sudo pwgen -N 1 -s 96 (Guardar essa chave1)</li>
                <li>echo -n ubsocial | sha256sum (Guardar essa chave2)</li>
                <li>sudo nano /etc/graylog/server/server.conf
                    <ul>
                        <li>(Informar na linha 57) password_secret = (chave1 acima)</li>
                        <li>(Informar na linha 68) root_password_sha2 = (chave2 acima)</li>
                        <li>(Descomentar e informar na linha 76) root_timezone = America/Sao_Paulo</li>
                        <li>(Descomentar e informar na linha 105) http_bind_address = ipMaquina (Ex: 172.16.0.12:9000)</li>
                        <li>(Inserir nova linha abaixo da linha 105): http_publish_uri = http://ipMaquina:9000/</li>
                        <li>(Inserir nova linha): http_external_uri = http://ipMaquina:9000</li>
                    </ul>
                </li>
                <li>sudo systemctl restart graylog-server
                    <ul>
                        <li>sudo systemctl start graylog-server</li>
                        <li>Verificar funcionamento: sudo systemctl status graylog-server</li>
                    </ul>
                </li>
                <li>sudo systemctl restart elasticsearch.service
                    <ul>
                        <li>Verificar funcionamento: sudo systemctl status elasticsearch.service</li>
                    </ul>
                </li>
                <li>Acessar painel do graylog: No browser, informar http://ipMaquina:9000
                    <ul>
                        <li>Usuário '<i>admin</i>', Senha '<i>ubsocial</i>'</li>
                    </ul>
                </li>
            </ul>
            
            <br>
            <h5>Inputs:</h5>
            <img src="../anexos/artigo5/graylogInputs.png" width="70%" height="auto">
            <p id="textoPost">Inputs de mensagens são responsáveis por levar os logs ao Graylog (Inputs para TCP, UDP, AWS, GCP, Containers...).</p>
            <p><b>Maquina Server (Ubuntu / graylog):</b></p>
            <p id="textoPost">Criar Input UDP: Objetivo é criar Input UDP para coletar logs das máquinas clients (Webserver/CentOS e Kibana/Debian). No graylog, aba System/Inputs, selecionar Syslog UDP e clicar em Launch New Input.</p>
            <ul>
                <li>Node selecionar o único (Máquina atual / graylog)</li>
                <li>Title “SYSLOG”</li>
                <li>Bind Address: 172.16.0.12 (ipMaquina)</li>
                <li>Port: 1514</li>
                <li>Selecionar opção ‘Allow overriding date?’ caso não esteja selecionada</li>
                <li>Save (O status do Graylog deverá ser Running)</li>
            </ul>
            <p><b>Máquina Cliente (CentOS / webserver):</b></p>
            <p id="textoPost">Configurar para encaminhar os logs desejados para o Graylog da máquina server (Porta 1514).</p>
            <ul>
                <li>sudo nano /etc/rsyslog.conf
                    <ul>
                        <li>(Editar última linha, descomentá-la) *.* @graylog:1514;RSYSLOG_SyslogProtoco123Format</li>
                    </ul>
                </li>
                <li>sudo systemctl restart rsyslog</li>
            </ul>
            <p><b>Maquina Cliente (Debian / kibana):</b></p>
            <ul>
                <li>sudo nano /etc/rsyslog.conf
                    <ul>
                        <li>(Editar última linha, descomentá-la) *.* @graylog:1514;RSYSLOG_SyslogProtoco123Format</li>
                    </ul>
                </li>
                <li>sudo systemctl restart rsyslog</li>
            </ul>
            <p><b>Maquina Server (Ubuntu / graylog):</b></p>
            <p id="textoPost">Após configuração das máquinas acima, verificar funcionamento do Graylog clicando em Show received messages, após recarregar página selecionar opção Search in all messages e no ícone de pesquisa informar ‘webserver’ seguido de Enter, para verificar logs da máquina cliente centOS webserver. Informar ‘kibana’ para verificar logs da máquina cliente debian kibana. Para mostrar logs em tempo real, selecionar, no select superior direito, o tempo de Update every 1 second.</p>
            <p id="textoPost">Fazer teste com log de autenticação, autenticando-se na máquina centOS webserver com senha errada.</p>
            <ul>
                <li>ssh suporte@172.16.0.11 (usuario@ipMaquina)</li>
                <li>Informar senha errada</li>
                <li>Verificar mensagens de logs no Graylog, onde estará, no topo, mensagem de erro de autenticação na máquina centOS webserver.</li>
            </ul>
        </div>
    </div>


</div>
</body>
</html>
